##########################################################################
## GAMBIT configuration for diver scan of the DMEFT model (preliminary)
##
## Contains relic density, gamma rays, direct detection, monojets
##########################################################################


Parameters:
    DMEFT:
      mchi: 332.1128381358704
      Lambda: 930. #1100. #870.
      C51: 0.0
      C61: -0.00010258182600253463
      C62: 0.22364830114644185
      C63: 0.17836385329472115
      C64: -0.0021231804192201054
      C52: 0.0
      C710: 0.0
      C71: 0.0
      C72: 0.0
      C73: 0.0
      C74: 0.0
      C75: 0.0
      C76: 0.0
      C77: 0.0
      C78: 0.0
      C79: 0.0
    # Halo_gNFW_rho0:
    #   alpha: 1.0
    #   beta: 3.0
    #   gamma: 1.0
    #   r_sun: 8.5
    #   rho0: 0.4006256826700886
    #   rs: 20.0
    #   v0: 240.00417916108398
    #   vesc: 533.0396709933165
    #   vrot: 240.00417916108398
    StandardModel_Higgs:
      mH: 125.09
    StandardModel_SLHA2:
      CKM_A: 0.814
      CKM_etabar: 0.353
      CKM_lambda: 0.22537
      CKM_rhobar: 0.117
      GF: 1.1663787e-05
      alpha1: 0.0
      alpha2: 0.0
      alphaS: 0.1181
      alphainv: 127.95
      delta13: 0.0
      mBmB: 4.18
      mCmC: 1.28
      mD: 0.0047
      mE: 0.000510998946
      mMu: 0.105658375
      mNu1: 0.0
      mNu2: 0.0
      mNu3: 0.0
      mS: 0.096
      mT: 173.3403202496713
      mTau: 1.77686
      mU: 0.0022
      mZ: 91.1876
      theta12: 0.58376
      theta13: 0.15495
      theta23: 0.76958
    # nuclear_params_ChPT:
    #   B0md: 0.00133
    #   B0ms: 0.268
    #   B0mu: 0.0061
    #   BT10dp: 0.24
    #   BT10s: 0.0
    #   BT10up: 3.0
    #   Deltadp: -0.376
    #   Deltas: -0.031
    #   Deltaup: 0.897
    #   F2sp: -0.064
    #   an: -1.913
    #   ap: 1.793
    #   gA: 1.2723
    #   gTd: -0.204
    #   gTs: 0.00032
    #   gTu: 0.794
    #   mG: 0.848
    #   mun: -1.913
    #   mup: 2.793
    #   sigmadn: 0.036
    #   sigmadp: 0.032
    #   sigmas: 0.0413
    #   sigmaun: 0.015
    #   sigmaup: 0.017


Priors:

  # All the priors are simple for this scan, so they are specified directly in the Parameters section.

Printer:

  printer: cout

  # printer: hdf5
  # options:
  #   buffer_length: 50
  #   output_file: "DMEFT_C73_diver_2TeV.hdf5"
  #   delete_file_on_restart: true
  #   group: "/DMEFT"

Scanner:

  use_scanner: random

  scanners:

    # grid:
    #   plugin: grid
    #   version: ">=1.0"
    #   like: LogLike
    #   grid_pts: [5, 3]
    #   parameters: ["EggBox::param_1", "EggBox::param_0"]

    random:
      plugin: random
      point_number: 1 #54
      output_file:  output
      like:  LogLike
      files:
        output_file: "weights ..."

    diver:
      plugin: diver
      like: LogLike
      NP: 100
      verbosity: 1
      convthresh: 1E-3
      lambdajDE: true

ObsLikes:

  # # Relic density
  # - capability: lnL_oh2
  #   purpose:    LogLike

  # - capability: RD_oh2
  #   purpose: Observable

  # # Direct detection
  # - capability: LUX_2016_LogLikelihood
  #   purpose:    LogLike

  # - capability: XENON1T_2018_LogLikelihood
  #   purpose:    LogLike

  # - capability: PandaX_2016_LogLikelihood
  #   purpose:    LogLike

  # - capability: PandaX_2017_LogLikelihood
  #   purpose:    LogLike

  # - capability: PICO_60_2017_LogLikelihood
  #   purpose:    LogLike

  # - capability: CRESST_II_LogLikelihood
  #   purpose:    LogLike

  # - capability: CDMSlite_LogLikelihood
  #   purpose:    LogLike

  # - capability: DarkSide_50_LogLikelihood
  #   purpose:    LogLike

  # # Indirect detection
  # - capability: lnL_FermiLATdwarfs
  #   purpose:    LogLike

  # - capability: sigmav
  #   purpose:    Observable

  # LHC likelihoods
  - purpose:    LogLike
    capability: LHC_Combined_LogLike
    module:     ColliderBit
    type: double

  - purpose:    Observable
    capability: LHC_signals

  - purpose:    likelihood_details
    capability: LHC_LogLike_per_SR

  - purpose:    likelihood_details
    capability: LHC_LogLike_SR_indices

  - purpose:    Observable
    capability: DMEFT_profiled_LHC_nuisance_params

Rules:

  - capability: RD_oh2
    function: RD_oh2_general # Use the DarkBit native calculator for the relic density
    #function: RD_oh2_MicrOmegas # NOT YET WORKING Use MicrOMEGAs for the relic density

  # Choose to implement the relic density likelihood as an upper bound, not a detection
  - capability: lnL_oh2
    function: lnL_oh2_upperlimit

  # Choose to rescale signals in direct and indirect detection by the relic density fraction
  - capability: RD_fraction
    function: RD_fraction_leq_one

  # Choose to use DarkSUSY's yield tables for indirect detection
  - capability: SimYieldTable
    function: SimYieldTable_DarkSUSY
    options:
      allow_yield_extrapolation: true

  # Choose to get decay rates from DecayBit proper, not an SLHA file
  - capability: decay_rates
    function: all_decays

  # Feed non-relativistic couplings into DDCalc
  - capability: DDCalc_Couplings
    function: DDCalc_Couplings_NR_WCs

  # Choose 5 quark flavour scheme for DirectDM
  - capability: DD_nonrel_WCs
    function: DD_nonrel_WCs_flavscheme

  # Choose colliders to simulate and their convergence settings, and pick analyses to run with each collider.
  - capability: RunMC
    function: InterpolatedMCInfo 
    module: ColliderBit

  - capability: LHC_LogLikes
    backends:
    - {capability: lnlike_marg_poisson_lognormal_error}
    options: 
      # covariance_marg_convthres_abs: 0.05
      # covariance_marg_convthres_rel: 0.05
      # covariance_nsamples_start: 100000
      use_covariances: true
      combine_SRs_without_covariances: false
      use_marginalising: false
      nuisance_prof_initstep: 0.1
      nuisance_prof_convtol: 0.01
      nuisance_prof_maxsteps: 5000
      nuisance_prof_convacc: 0.01
      nuisance_prof_simplexsize: 1e-5
      nuisance_prof_method: 5  # See list of GSL optimiser methods below
      nuisance_prof_verbosity: 0

  - capability: LHC_Combined_LogLike
    options:
      cap_loglike: false
      cap_loglike_individual_analyses: false
      skip_analyses:
        - CMS_13TeV_MONOJET_36invfb_interpolated_nocovar

  - capability: DMEFT_profiled_LHC_nuisance_params
    function: calc_DMEFT_profiled_LHC_nuisance_params
    options:
      # use_fixed_value_a: 100.0  # This will switch off the profling 
      init_values_a: [1.0, 10.0, 500.]
      range_a: [0.0, 1000.0]
      nuisance_prof_initstep: 0.1
      nuisance_prof_convtol: 0.1
      nuisance_prof_maxsteps: 15
      nuisance_prof_convacc: 0.1
      nuisance_prof_simplexsize: 1e-5
      nuisance_prof_method: 6  # See list of GSL optimiser methods below. NOTE: Here we can't use a gradient-based method!
      nuisance_prof_verbosity: 0

    # GSL optimiser methods:
    #  0: Fletcher-Reeves conjugate gradient
    #  1: Polak-Ribiere conjugate gradient
    #  2: Vector Broyden-Fletcher-Goldfarb-Shanno method
    #  3: Steepest descent algorithm
    #  4: Nelder-Mead simplex
    #  5: Vector Broyden-Fletcher-Goldfarb-Shanno method ver. 2
    #  6: Simplex algorithm of Nelder and Mead ver. 2
    #  7: Simplex algorithm of Nelder and Mead: random initialization

  - capability: AllAnalysisNumbers
    function: DMEFT_results_profiled

  # Use the WIMP properties structure to get WIMP mass etc.
  - capability: mwimp
    function: mwimp_from_WIMPprops

  - capability: wimp_sc
    function: wimp_sc_from_WIMPprops

  - capability: spinwimpx2
    function: jwimpx2_from_WIMPprops

Logger:

  redirection:
    [Debug] : "debug.log"
    [Default] : "default.log"
    [DecayBit] : "DecayBit.log"
    [PrecisionBit] : "PrecisionBit.log"
    [ColliderBit] : "ColliderBit.log"
    [SpecBit] : "SpecBit.log"
    [Dependency Resolver] : "dep_resolver.log"

KeyValues:

  dependency_resolution:
    prefer_model_specific_functions: true

  likelihood:
    model_invalid_for_lnlike_below: -5e5
    model_invalid_for_lnlike_below_alt: -1e5

  default_output_path: "runs/DMEFT_collider_debug/"

  debug: true
  print_timing_data: false
