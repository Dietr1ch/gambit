#######################################################################################################################################
## GAMBIT configuration file for a Diver scan of the DMEFT model
##
## Constrains: relic density, gamma rays, solar neutrinos, CMB, direct detection, LHC likelihood (full and profile cut-off by default).
##
## 16 model parameters (mchi, Lambda, C61-64 and C71-C710 (WCs for Dim-6 & Dim-7 operators))
## 8 nuisance parameters (mtrunIN, rho0, v0, vesc, sigmapiN, Deltas, gTs, rs2)
########################################################################################################################################


Parameters:

  DMEFT:
    C51: 0
    C52: 0
    C61: 5.50862
    C62: 0.00206102
    C63: -0.0711872
    C64: -0.000153075
    C71: 2.71451
    C710: 0.000972777
    C72: 0.243377
    C73: -5.12983e-06
    C74: 9.5544
    C75: -8.75072e-06
    C76: 0.000354484
    C77: -0.0480421
    C78: 1.43825e-05
    C79: -1.303e-05
    Lambda: 14852.5
    mchi: 7.14021
    mtrunIN: 160.884
  StandardModel_Higgs:
    mH: 125.1
  StandardModel_SLHA2:
    CKM_A: 0.814
    CKM_etabar: 0.353
    CKM_lambda: 0.22537
    CKM_rhobar: 0.117
    GF: 1.16638e-05
    alpha1: 0
    alpha2: 0
    alphaS: 0.1181
    alphainv: 127.95
    delta13: 0
    mBmB: 4.18
    mCmC: 1.28
    mD: 0.0047
    mE: 0.000510999
    mMu: 0.105658
    mNu1: 0
    mNu2: 0
    mNu3: 0
    mS: 0.096
    mT: 173.34
    mTau: 1.77686
    mU: 0.0022
    mZ: 91.1876
    theta12: 0.58376
    theta13: 0.15495
    theta23: 0.76958

Priors:

  # All the priors are simple for this scan, so they are specified directly in the Parameters section.

ObsLikes:

  # Indirect detection
  - capability: lnL_FermiLATdwarfs
    purpose:    LogLike

  - capability: sigmav
    purpose:    Observable

Rules:

  # Relic density likelihood
  - capability: lnL_oh2
    # Choose to implement the relic density likelihood as an upper bound, not a detection
    function: lnL_oh2_upperlimit
    # Choose to implement the relic density likelihood as a detection
    # function: lnL_oh2_Simple
    options: # Planck 2018 values
      oh2_obs: 0.120
      oh2_obserr: 0.001
      oh2_fractional_theory_err: 0.01

    options: # Planck 2018 values
      oh2_obs: 0.120
      oh2_obserr: 0.001
      oh2_fractional_theory_err: 0.01

  # Choose to rescale signals in direct and indirect detection by the relic density fraction
  - capability: RD_fraction
    function: RD_fraction_leq_one
    options: # Planck 2018 values
      oh2_obs: 0.120

  # Use DarkSUSY directly , MicrOmegas or the DarkBit native calculator (based on the DarkSUSY Boltzmann solver) for the relic density?
  # Consult the DarkBit manual for the required options in each case
  - capability: RD_oh2
    #function: RD_oh2_DS5_general
    function: RD_oh2_DS_general
    options:
      # these options are identical for DS5 and DS6+ version
      fast: 1  # 0: standard, 1: fast (default)
    #function: RD_oh2_DarkSUSY_DS5
    #options:
    #  fast: 1  # 0: standard (default), 1: fast, 2: dirty
    #  omtype: 1  # 0: no coann, 1: all coann (default)
    #function: RD_oh2_MicrOmegas
    #options:
    #  fast: 1  # 0: standard (default), 1: fast
    #  Beps: 1e-5  #  1e-5: standard, 1: switches coann off

  # Choose between the functions sigmav_late_universe and sigmav_late_universe_MicrOmegas
  - capability: sigmav
    function: sigmav_late_universe

  # Choose to set to zero yields out of range of the tables
  - module: DarkBit
    options:
      out_of_range_zero_yield: true

  # Choose to use DarkSUSY yield tables for indirect detection
  - capability: GA_SimYieldTable
    #function: GA_SimYieldTable_DS5
    function: GA_SimYieldTable_DarkSUSY
    options:
      allow_yield_extrapolation: true

  # Also need to choose which tables to use for positrons,
  # antideuterons, and antiprotons (or opt for empty tables)
  - capability: positron_SimYieldTable
    #function: positron_SimYieldTable_empty
    function: positron_SimYieldTable_DarkSUSY

  - capability: antiproton_SimYieldTable
    #function: antiproton_SimYieldTable_empty
    function: antiproton_SimYieldTable_DarkSUSY

  - capability: antideuteron_SimYieldTable
    #function: antideuteron_SimYieldTable_empty
    function: antideuteron_SimYieldTable_DarkSUSY

  # Take the electron yields directly from the positron yields
  # (So far it is the only option, may change in the future)
  - capability: electron_SimYieldTable
    function: electron_SimYieldTable_from_positron_SimYieldTable

  # The model is annihilating DM, not decaying
  - capability: GA_Yield
    function: GA_AnnYield_General

  - capability: electron_Yield
    function: electron_AnnYield_General

  - capability: positron_Yield
    function: positron_AnnYield_General

  - capability: capture_rate_Sun
    function: capture_rate_Sun_NREO

  # Tell DarkAges to calculate f_eff(z)
  - capability: DarkAges_1_2_0_init
    options:
      f_eff_mode: true

  # Calculate the constant f_eff by convolution of f_eff(z) with a weighting function
  - capability: f_eff
    function: f_eff_weighted

  # Choose to get decay rates from DecayBit proper, not an SLHA file
  - capability: decay_rates
    function: all_decays

  # Feed non-relativistic couplings into DDCalc
  - capability: DDCalc_Couplings
    function: DDCalc_Couplings_NR_WCs

  # Choose 5 quark flavour scheme for DirectDM
  - capability: DD_nonrel_WCs
    function: DD_nonrel_WCs_flavscheme

  # Use LHC analyses based on fast interpolation rather than on-the-fly MC simulation
  - capability: RunMC
    function: InterpolatedMCInfo
    module: ColliderBit

  - capability: LHC_Combined_LogLike
    options:
      # Do not use capped LHC loglike, change to true if desired
      cap_loglike: false

  - capability: LHC_LogLikes
    backends:
    - {capability: lnlike_marg_poisson_lognormal_error}
    options:
      # covariance_marg_convthres_abs: 0.05
      # covariance_marg_convthres_rel: 0.05
      # covariance_nsamples_start: 100000
      use_covariances: true
      combine_SRs_without_covariances: false
      use_marginalising: false
      nuisance_prof_initstep: 0.1
      nuisance_prof_convtol: 0.01
      nuisance_prof_maxsteps: 10000
      nuisance_prof_convacc: 0.01
      nuisance_prof_simplexsize: 1e-5
      nuisance_prof_method: 6
      nuisance_prof_verbosity: 0

    # Signal yields for LHC analyses
  - capability: AllAnalysisNumbers
    # Profile over the cut-off parameter for pT/ETmiss > Lambda
    function: DMEFT_results_profiled
    # Hard cut-off of the pT/ETmiss spectrum for pT/ETmiss > Lambda
    # function: DMEFT_results_cutoff

  # Profile nuisance parameter a for LHC likelihoods
  # Remove or set a fixed value if using the function DMEFT_results_cutoff to fulfil AllAnalysisNumbers
  - capability: DMEFT_profiled_LHC_nuisance_params
    function: calc_DMEFT_profiled_LHC_nuisance_params
    options:
      # use_fixed_value_a: 1000.0  # This will switch off the profiling
      init_values_a: [1.0, 2.0, 3.0]
      range_a: [0.0, 4.0]
      nuisance_prof_initstep: 0.1
      nuisance_prof_convtol: 0.1
      nuisance_prof_maxsteps: 15
      nuisance_prof_convacc: 0.1
      nuisance_prof_simplexsize: 1e-5
      nuisance_prof_method: 6
      nuisance_prof_verbosity: 0

  ## Halo nuisances settings
  # Set v0 to 240 +/- 8 km/s based on Reid et al [arXiv:1401.5377]
  - capability: lnL_v0
    function: lnL_v0_gaussian
    options:
      v0_obs: 240
      v0_obserr: 8

  # Set vesc to 528 +/- 25 km/s based on Gaia data [arXiv:1901.02016]
  - capability: lnL_vesc
    function: lnL_vesc_gaussian
    options:
      vesc_obs: 528
      vesc_obserr: 25

Logger:

  redirection:
    [Debug] : "debug.log"
    [Default] : "default.log"
    [DecayBit] : "DecayBit.log"
    [Dependency Resolver] : "dep_resolver.log"

Printer:

  printer: hdf5
  options:
    output_file: "DMEFT.hdf5"
    delete_file_on_restart: false
    buffer_length: 100
    group: "/DMEFT"

Scanner:

  use_scanner: random

  scanners:

    random:
      plugin: random
      like: LogLike
      point_number: 1

    diver:
      plugin: diver
      like: LogLike
      NP: 50000
      verbosity: 1
      convthresh: 1E-5
      lambdajDE: false

KeyValues:

  dependency_resolution:
    prefer_model_specific_functions: true

  likelihood:
    model_invalid_for_lnlike_below: -5e5
    model_invalid_for_lnlike_below_alt: -1e5
    print_invalid_points: false
    debug: false

  default_output_path: "runs/DMEFT/"

  debug: true
  print_timing_data: false
